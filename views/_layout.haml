%html
  %head
    %title {Title}{block:SearchPage} ({lang:Search results for SearchQuery}){/block:SearchPage}{block:PermalinkPage}{block:PostSummary} â€” {PostSummary}{/block:PostSummary}{/block:PermalinkPage}
    %meta{:charset => "utf-8"}/
    %meta{:content => "{block:IndexPage}{block:Description}{MetaDescription}{/block:Description}{/block:IndexPage}{block:PermalinkPage}{block:PostSummary}{PostSummary}{/block:PostSummary}{/block:PermalinkPage}", :name => "description"}/
    %meta{:content => "#4EA3D0", :name => "color:Accent"}/
    %meta{:content => "'Helvetica Neue', Helvetica, Arial, sans-serif", :name => "font:Body"}/
    = render 'appearance_options'
    %link{:href => "{Favicon}", :rel => "shortcut icon"}/
    %link{:href => "{RSS}", :rel => "alternate", :title => "RSS", :type => "application/rss+xml"}/
    / HTML5 Shiv
    /[if lt IE 9] <script src="http://static.tumblr.com/hriofhd/Qj0m8pn7q/html5shiv.js"></script>
    / Reset CSS
    %link{:href => "http://static.tumblr.com/thpaaos/DIcklyl4z/reset.css", :rel => "stylesheet", :type => "text/css"}/
    / Theme CSS
    %style{:media => "screen", :type => "text/css"}
      = render 'style'
    / Custom CSS
    %style{:media => "screen", :type => "text/css"}
      {CustomCSS}
  %body
    %section#container.group
      = yield
      %footer#footer
        %section.copyright &copy; {CopyrightYears} {Title}
        {block:Pagination}
        %nav.pagination
          %section.buttons
            {block:PreviousPage}
            %a.left{:href => "{PreviousPage}"}>
              {lang:Previous page}
              %span.arrow
            {/block:PreviousPage}
            {block:NextPage}
            %a.right{:href => "{NextPage}"}>
              {lang:Next page}
              %span.arrow
            {block:NextPage}
          %section.disabled.buttons
            %li.left
              %span.arrow
            %li.right
              %span.arrow
          %section.count Page  {CurrentPage} / {TotalPages}
        {/block:Pagination}

    {block:IfUseEndlessScrolling}
    %script{:src => "http://assets.tumblr.com/javascript/jquery-1.7.2.min.js", :type => "text/javascript"}
    :javascript
      var Tumblelog = {};
      
      // Infinite Scroll
      Tumblelog.Infinite = (function() {
      
          var _$window          = $(window);
          var _$posts           = $('#posts');
          var _trigger_post     = null;
      
          var _current_page     = {CurrentPage};
          var _total_pages      = {TotalPages};
          var _url              = document.location.href;
          var _infinite_timeout = null;
          var _is_loading       = false;
          var _posts_loaded     = false;
      
          function init() {            
              set_trigger();
              enable_scroll();
          }
      
          function set_trigger () {
              var $all_posts = _$posts.find('li.post');
          
              if (!_posts_loaded) {
                  _posts_loaded = $all_posts.length;
              }
          
              if (_posts_loaded >= 4) {
                  _trigger_post = _$posts.find('li.post:eq(' + ($all_posts.length - 4) + ')').get(0);
              } else if (_posts_loaded >= 3) {
                  _trigger_post = _$posts.find('li.post:eq(' + ($all_posts.length - 3) + ')').get(0);
              } else {
                  _trigger_post = _$posts.find('li.post:last').get(0);
              }
          };
      
          function in_viewport (el) {
              if (el == null) return;
              var top = el.offsetTop;
              var height = el.offsetHeight;
      	
              while (el.offsetParent) {
                  el = el.offsetParent;
                  top += el.offsetTop;
              }
      	
              return (top < (window.pageYOffset + window.innerHeight));
          };
      
          function enable_scroll() {
              $('#footer .pagination').hide();
              _$window.scroll(function(){
                  clearTimeout(_infinite_timeout);
                  infinite_timeout = setTimeout(infinite_scroll, 100);
              });
          }
      
          function disable_scroll() {
              clearTimeout(_infinite_timeout);
              $(window).unbind('scroll');
          }
      
          function infinite_scroll() {
              if (_is_loading) return;

              if (in_viewport(_trigger_post)) {
                  load_more_posts(); // w00t
              }
          };
      
          function load_more_posts() {
              if (_is_loading) return;
              _is_loading = true;

              // Build URL
              if (_url.charAt(_url.length - 1) != '/') _url += '/';
              if (_current_page === 1) _url += 'page/1';
              _current_page++;
              _url = _url.replace('page/' + (_current_page - 1), 'page/' + _current_page);

              // Fetch URL
              $.ajax({
                  url: _url,
                  dataType: 'html',
                  success: function(data, textStatus, jqXHR) {
                      var $new_posts   = $('#posts', data);
                      _posts_loaded = $new_posts.find('li.post').length;

                      // Insert new posts
                      var new_posts_html = $new_posts.html();
                      $('#posts').append(new_posts_html);
    
                      // Eval scripts with the inline_embed class (HTML5 video)
                      var reponse = jQuery(jqXHR.responseText);
                      var reponseScript = reponse.filter('script');
                      jQuery.each(reponseScript, function(idx, val) {
                          if($(val).hasClass('inline_embed')) { eval(val.text); }
                      });
    
                      if ((_posts_loaded > 0) && (_current_page < _total_pages)) {
                          set_trigger();
                          _is_loading = false;
                      } else {
                          disable_scroll();
                      }
                  }
              });
      	
          }
          
          return {
              init: init
          };
      });
      
      $(function() {
          if ( !($.browser.msie && (parseInt($.browser.version, 10) < 9) ) ) {
              var InfiniteScroll = new Tumblelog.Infinite;
              InfiniteScroll.init();
          }
      });
    {/block:IfUseEndlessScrolling}
    
    {block:IfUseEndlessScrolling}
    %script{:src => "http://assets.tumblr.com/javascript/tumblelog.js", :type => "text/javascript"}
    {/block:IfUseEndlessScrolling}
